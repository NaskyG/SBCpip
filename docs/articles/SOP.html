<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stanford Blood Center Operating Procedures • SBCpip</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Stanford Blood Center Operating Procedures">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SBCpip</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.3.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/SOP.html">Stanford Blood Center Operating Procedures</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Stanford Blood Center Operating Procedures</h1>
                        <h4 class="author">Balasubramanian Narasimhan</h4>
            
            <h4 class="date">2018-08-17</h4>
      
      
      <div class="hidden name"><code>SOP.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This is a brief introduction to how the <code>pip</code> package and <code>SBCpip</code> packages work together.</p>
<p>Why two packages?</p>
<p>The <code>pip</code> package is meant to be site-independent. In other words, all it does is the training and prediction. In its current implementation, it tries very hard to be faithful the original <span class="citation">Guan et al. (2017)</span> publication.</p>
<p>The <code>SBCpip</code> is the Stanford Blood Center (SBC) site-specific package. The main job of <code>SBCpip</code> is to provide functionality tailor-made for the workflow in use at SBC. This task may sometimes be quite involved and prone to change.</p>
<p>The separation makes it possible for sites to modify both packages to make use of many other features besides those used in the reference.</p>
<p><strong>Note</strong> Some of the steps described here are SBC-specific and so don’t be surprised if you don’t have access to the data referred to.</p>
</div>
<div id="steps" class="section level2">
<h2 class="hasAnchor">
<a href="#steps" class="anchor"></a>Steps</h2>
<p>To get things started, one has to begin with some historical data on the CBC, census and transfusion to get the prediction pipeline going.</p>
<p>The folder <code>Blood_Center</code> for example contains data for the period April 1, 2017 through April 9, 2018. Note that the file created on April 9, for example, has data from the previous date.</p>
<p>Such data can be used to build up a <em>seed</em> database to start the prediction pipeline.</p>
<div id="generating-the-seed-data" class="section level3">
<h3 class="hasAnchor">
<a href="#generating-the-seed-data" class="anchor"></a>Generating the Seed Data</h3>
<p>The seed database is generated exactly once. To build the seed database, follow the procedure below.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(SBCpip)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">options</span>(<span class="dt">warn =</span> <span class="dv">1</span>) <span class="co">## Report warnings as they appear</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">config &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_SBC_config.html">get_SBC_config</a></span>() <span class="co">## Get default site specific configuration</span></a></code></pre></div>
<p>The <code>config</code> object is a rather large object that contains all configuration information. It is documented with the package. Specifically, one can specify data folders, report folders and output folders, as the example below shows.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">## Specify the data location</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">config &lt;-<span class="st"> </span><span class="kw">set_data_folder</span>(<span class="st">"full_path_to_historical_data"</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">## existing report files will be overwritten</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">config &lt;-<span class="st"> </span><span class="kw">set_report_folder</span>(<span class="st">"full_path_to_report_folder"</span>) </a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">## existing output files will be overwritten</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">config &lt;-<span class="st"> </span><span class="kw">set_output_folder</span>(<span class="st">"full_path_to_output_folder"</span>)</a></code></pre></div>
<p>One can then process all files in the data folder as follows and save the seed data. Note that the files in the data folder are presumed to follow a naming pattern: - <code>LAB-BB-CSRP-CBC*</code> for CBC files - <code>LAB-BB-CSRP-Census*</code> for Census files - <code>LAB-BB-CSRP-Transfused*</code> for transfusion files.</p>
<p>The <code>process__all_...</code> functions below accept a <code>pattern</code> argument if you want to change them.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">## This is for creating the seed dataset</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">cbc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/process_all_cbc_files.html">process_all_cbc_files</a></span>(<span class="dt">data_folder =</span> config<span class="op">$</span>data_folder,</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">                             <span class="dt">cbc_abnormals =</span> config<span class="op">$</span>cbc_abnormals,</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">                             <span class="dt">cbc_vars =</span> config<span class="op">$</span>cbc_vars,</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">                             <span class="dt">verbose =</span> config<span class="op">$</span>verbose)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">census &lt;-<span class="st"> </span><span class="kw"><a href="../reference/process_all_census_files.html">process_all_census_files</a></span>(<span class="dt">data_folder =</span> config<span class="op">$</span>data_folder,</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">                                   <span class="dt">locations =</span> config<span class="op">$</span>census_locations,</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">                                   <span class="dt">verbose =</span> config<span class="op">$</span>verbose)</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">transfusion &lt;-<span class="st"> </span><span class="kw"><a href="../reference/process_all_transfusion_files.html">process_all_transfusion_files</a></span>(<span class="dt">data_folder =</span> config<span class="op">$</span>data_folder,</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">                                             <span class="dt">verbose =</span> config<span class="op">$</span>verbose)</a>
<a class="sourceLine" id="cb3-13" data-line-number="13"></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="co">## Save the SEED dataset so that we can begin the process of building the model.</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">## This gets us to date 2018-04-09-08-01-54.txt, so we save data using that date</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="kw">saveRDS</span>(<span class="kw">list</span>(<span class="dt">cbc =</span> cbc, <span class="dt">census =</span> census, <span class="dt">transfusion =</span> transfusion),</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">        <span class="dt">file =</span> <span class="kw">file.path</span>(config<span class="op">$</span>output_folder,</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">                         <span class="kw">sprintf</span>(config<span class="op">$</span>output_filename_prefix, <span class="st">"2018-04-09"</span>)))</a></code></pre></div>
<p>At this point an <code>RDS</code> file is created that is sufficient to get started.</p>
</div>
</div>
<div id="processing-incremental-files" class="section level2">
<h2 class="hasAnchor">
<a href="#processing-incremental-files" class="anchor"></a>Processing Incremental Files</h2>
<p>Incremental files are also expected to follow a certain naming pattern. Default patterns are specified in the config variable.</p>
<ul>
<li>
<code>config$cbc_filename_prefix</code> for cbc</li>
<li>
<code>config$census_filename_prefix</code> for census</li>
<li>
<code>config$transfusion_filename_prefix</code> for transfusion</li>
<li>
<code>config$inventory_file_name_prefix</code> for inventory (not used currently)</li>
</ul>
<p>One merely sets the data folder to point to the full path of the incremental files which is typically populated every day and proceed as below.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">## Now process the incremental files</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">## Point to folder containing incrementals</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">config &lt;-<span class="st"> </span><span class="kw">set_data_folder</span>(<span class="st">"full_path_to_incremental_data"</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">## One may or may not choose to set the incremental reports to go</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">## to another location as shown below.</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">config &lt;-<span class="st"> </span><span class="kw">set_report_folder</span>(<span class="st">"full_path_to_incremental_data_reports"</span>)</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">## Same for output although not shown.</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">By specifying, the starting and ending dates, one can process all files <span class="cf">in</span> one swoop.</a></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">start_date &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="st">"2018-04-10"</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">end_date &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="st">"2018-05-29"</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">all_dates &lt;-<span class="st"> </span><span class="kw">seq.Date</span>(<span class="dt">from =</span> start_date, <span class="dt">to =</span> end_date, <span class="dt">by =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">prediction &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(all_dates)) {</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">    date_str &lt;-<span class="st"> </span><span class="kw">as.character</span>(all_dates[i])</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">    <span class="co">##print(date_str)</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">    result &lt;-<span class="st"> </span><span class="kw"><a href="../reference/predict_for_date.html">predict_for_date</a></span>(<span class="dt">config =</span> config, <span class="dt">date =</span> date_str)</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">    prediction &lt;-<span class="st"> </span><span class="kw">c</span>(prediction, result<span class="op">$</span>three_days_sum)</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">}</a></code></pre></div>
<p>The above loop goes through several steps.</p>
<ol style="list-style-type: decimal">
<li>It loads previous day’s data</li>
<li>It processes the incremental data and appends it to existing data</li>
<li>It determines if the model needs to be updated. A parameter <code>config$model_update_frequency</code> (default 7) decides how often the model is retrained. The code can detect if the model is to be constructed for the first time!</li>
<li>If the model is retrained, the training dataset is constructed, scaled, and scaling parameters stored for use in the future. Otherwise, the existing scaling parameters are used to construct the data set for prediction</li>
<li>The prediction is made and results stored for the next day. The current prediction is the three-day sum.</li>
</ol>
</div>
<div id="daily-routine" class="section level2">
<h2 class="hasAnchor">
<a href="#daily-routine" class="anchor"></a>Daily Routine</h2>
<p>Thus, for daily routine, all that needs to be done is to call the function</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">result &lt;-<span class="st"> </span><span class="kw"><a href="../reference/predict_for_date.html">predict_for_date</a></span>(<span class="dt">config =</span> config)</a></code></pre></div>
<p>This automatically assumes the date to be the current date. It can be specified if necessary using the <code>date</code> argument thus.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">result &lt;-<span class="st"> </span><span class="kw"><a href="../reference/predict_for_date.html">predict_for_date</a></span>(<span class="dt">config =</span> config, <span class="dt">date =</span> <span class="st">"2018-04-30"</span>)</a></code></pre></div>
<p>Note that this default daily routine makes the assumption that - the data for day i is available early on day i + 1 - the prediction is done on day i+1 for the purpose of ordering units, i.e. there is sufficient time to be able to do this as regards the logistics - the prediction is really for day i, rather than day i + 1.</p>
<p>Not paying attention to this can lead to off-by-one migranes!</p>
</div>
<div id="shiny-dashboard" class="section level2">
<h2 class="hasAnchor">
<a href="#shiny-dashboard" class="anchor"></a>Shiny Dashboard</h2>
<p>A shiny dashboard is available for those more used to point-and-click interfaces, invoked via <code><a href="../reference/sbc_dashboard.html">SBCpip::sbc_dashboard()</a></code>.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Guan11368">
<p>Guan, Leying, Xiaoying Tian, Saurabh Gombar, Allison J. Zemek, Gomathi Krishnan, Robert Scott, Balasubramanian Narasimhan, Robert J. Tibshirani, and Tho D. Pham. 2017. “Big Data Modeling to Predict Platelet Usage and Minimize Wastage in a Tertiary Care System.” <em>Proceedings of the National Academy of Sciences</em> 114 (43). National Academy of Sciences: 11368–73. <a href="https://doi.org/10.1073/pnas.1714097114" class="uri">https://doi.org/10.1073/pnas.1714097114</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#steps">Steps</a></li>
      <li><a href="#processing-incremental-files">Processing Incremental Files</a></li>
      <li><a href="#daily-routine">Daily Routine</a></li>
      <li><a href="#shiny-dashboard">Shiny Dashboard</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="https://www.linkedin.com/in/leying-guan-3b225a69">Leying Guan</a>, <a href="https://statweb.stanford.edu/~tibs">Robert J. Tibshirani</a>, <a href="https://profiles.stanford.edu/saurabh-gombar">Saurabh Gombar</a>, <a href="https://med.stanford.edu/profiles/tho-duc-pham">Tho Duc Pham</a>, <a href="https://statweb.stanford.edu/~naras">Balasubramanian Narasimhan</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
